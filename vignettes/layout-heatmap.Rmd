---
title: "Heatmap Layout"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Heatmap Layout}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`layout_heatmap()` utilizes the grammar of graphics to construct the heatmap and
heatmap annotations. You can also use the alias `ggheatmap`.

```{r setup}
library(ggalign)
```

## Input data 
The data input can be a numeric or character vector, a data frame, and any other
data which can be converted into a matrix. Simple vector will be converted into
a one column matrix. 

```{r setup_data}
set.seed(123)
small_mat <- matrix(rnorm(81), nrow = 9)
rownames(small_mat) <- paste0("row", seq_len(nrow(small_mat)))
colnames(small_mat) <- paste0("column", seq_len(ncol(small_mat)))
```

```{r matrix}
ggheatmap(small_mat)
```

## Heatmap body
For `ggplot2` usage, the matrix input will be converted into a long formated
data frame when drawing. The default mapping will use `aes(.data$.x, .data$.y)`,
but can be controlled using `mapping` argument. The data in the underlying
ggplot object contains following columns:

  - `.xpanel` and `.ypanel`: the column and row panel

  - `.x` and `.y`: the `x` and `y` coordinates

  - `.row_names` and `.column_names`: the row and column names of the original
    matrix (only applicable when names exist).

  - `.row_index` and `.column_index`: the row and column index of the original
    matrix.

  - `value`: the actual matrix value.

If `filling = TRUE`, the following layer will be added automatically:
```{r}
geom_tile(
  aes(.data$.x, .data$.y, fill = .data$value),
  width = 1L, height = 1L
)
```

If you set `filling = FALSE`, a blank heamtap will be drawn.
```{r}
ggheatmap(small_mat, filling = FALSE)
```

You can treat the `LayerHeatmap` object as a normal ggplot2 object with a
default `mapping` and `data`. You can add `ggplot2` elements as usual.
```{r}
ggheatmap(small_mat) + geom_point() + scale_fill_viridis_c()
```

## Heatmap annotations
Heatmap annotations add extra information to the rows or columns of your
heatmap. Annotations can be positioned at the `top`, `left`, `bottom`, or
`right` of the heatmap, and this positioning is referred to as the active
context in `ggheatmap()`. 

By default, the `ggheatmap()` won't initialize any active context, so if you
want to add something into the heatmap annotations, you need to use `hmanno()`
to specify where the annotation should be added.

```{r}
ggheatmap(small_mat) +
  hmanno("t") +
  align_kmeans(3L)
```

When you set an active context with `hmanno()`, all subsequent additions will be
directed to this annotation. This allows you to customize the heatmap by adding
different types of plots. Annotation is represented as `layout_stack()` object,
which can contain multiple plots. You can also specify which plot context of the
annotation to use with the `what` argument in `hmanno()`. However, this is
usually not necessary as each `align_*` function has a `set_context` argument
that controls whether it sets the active context to the `Align` object when
added to the stack layout:

- For `align_*` functions that draw something (e.g., `align_dendro()`,
  `ggalign()`), `set_context` is set to `TRUE` by default. 
- For `align_*` functions that do not draw anything (e.g., `align_group()`,
  `align_kmeans()`), `set_context` is set to `FALSE` by default.

```{r}
ggheatmap(small_mat) +
  theme(axis.text.x = element_text(angle = -60, hjust = 0)) +
  hmanno("r") +
  align_dendro(k = 3L) +
  geom_point(aes(color = factor(branch)))
```

In this example:

 - `hmanno("r")` specifies that the annotation should be positioned on the right of the heatmap.
 - `align_dendro(k = 3L)` adds a dendrogram to this right-side annotation context
   and sets it as the active plot in the annotation stack. 
 - `geom_point(aes(color = factor(branch)))` is then added to this active plot within
   the annotation stack, allowing you to include additional visual elements. 

If you set `set_context = FALSE`, this will be an error, since no active ggplot
object can be found.
```{r error = TRUE}
ggheatmap(small_mat) +
  hmanno("r") +
  align_dendro(k = 3L, set_context = FALSE) +
  geom_point(aes(color = factor(branch)))
```

## Control size
`hmanno()` has `width` and `height` to control the relative (you can also
provide a unit object) width and height of the heatmap body. In addition,
`hmanno()` function have a `size` argument to control the relative width (left
and right annotation) or height (top and bottom annotation) of the whole
annotation. `anno_*` function has a `size` argument to control the relative
width (left and right annotation) or height (top and bottom annotation) of the
single annotation in the whole annotation stack.

```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = unit(20, "mm")) +
  ggalign(data = rowSums) +
  geom_bar(aes(y = value, fill = .x), stat = "identity") +
  hmanno("l", size = 0.2) +
  ggalign(aes(x = value), data = rowSums) +
  geom_bar(
    aes(y = .y, fill = factor(.y)),
    stat = "identity",
    orientation = "y"
  ) +
  scale_fill_brewer(palette = "Set1", guide = "none") +
  scale_x_reverse() +
  theme(axis.text.x = element_text(angle = -60, hjust = 0))
```

## Session information
```{r}
sessionInfo()
```
