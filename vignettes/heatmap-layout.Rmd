---
title: "Heatmap Layout"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    number_sections: no
    fig_caption: yes
    fig_width: 7
    fig_height: 7
vignette: >
  %\VignetteIndexEntry{Heatmap Layout}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
pkgdown:
  as_is: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`heatmap_layout()` utilizes the grammar of graphics to construct the heatmap and
heatmap annotations. You can also use the alias `ggheatmap()`.

```{r setup}
library(ggalign)
```

## input data
The data input can be a numeric or character vector, a data frame, and any other
data which can be converted into a matrix.

```{r setup_data}
set.seed(123)
small_mat <- matrix(rnorm(81), nrow = 9)
rownames(small_mat) <- paste0("row", seq_len(nrow(small_mat)))
colnames(small_mat) <- paste0("column", seq_len(ncol(small_mat)))
```

```{r matrix}
ggheatmap(small_mat)
```

## heatmap body
For `ggplot2` usage, the matrix input will be converted into a long formated
data frame when drawing. The default mapping will use `aes(.data$.x, .data$.y)`,
but can be controlled using `mapping` argument. The data in the underlying
ggplot object contains following columns:

  - `.xpanel` and `.ypanel`: the column and row panel

  - `.x` and `.y`: the `x` and `y` coordinates

  - `.row_names` and `.column_names`: A factor of the row and column names of
    the original matrix (only applicable when names exist).

  - `.row_index` and `.column_index`: the row and column index of the original
    matrix.

  - `value`: the actual matrix value.

You can treat the `heatmap_layout()` object as a normal ggplot2 object with a
default `mapping` and `data`. You can add `ggplot2` elements as usual.
```{r}
ggheatmap(small_mat) + geom_point() + scale_fill_viridis_c()
```

By default, we'll add the heatmap layer. If you set `filling = FALSE`, a blank
heamtap will be drawn.
```{r}
ggheatmap(small_mat, filling = FALSE)
```

## heatmap annotations
Heatmap annotations provide additional information for the rows or columns of
the heatmap and can be placed at the `top`, `left`, `bottom`, or `right`. An
annotation is a `stack_layout()` object internally, capable of holding multiple
plots.

By default, `ggheatmap()` does not initialize an active context, so all
additions are placed within the heatmap body. You can use `hmanno()` to set the
active context, directing all subsequent additions to this position. The active
context allows for custom layout adjustments and the addition of various plot
types.

In the following example, `align_kmeans()` is used to group the columns into 3
panels. It doesn't matter if this is added to the top or bottom since it won't
add a plot area:

```{r}
ggheatmap(small_mat) +
  hmanno("t") +
  align_kmeans(3L)
```

We can add any `align_*()` function to the annotation. For more details on
`align_*()` functions, refer to `vignette("layout-customize")` and
`vignette("layout-plot")`.

```{r}
ggheatmap(small_mat) +
  theme(axis.text.x = element_text(angle = -60, hjust = 0)) +
  hmanno("r") +
  align_dendro(k = 3L) +
  geom_point(aes(color = factor(branch)))
```

In this example:

 - `hmanno("r")` change the active context to the right of the heatmap.
 - `align_dendro(k = 3L)` adds a dendrogram to this right-side annotation
 context and sets itself as the active plot in the annotation stack. 
 - `geom_point(aes(color = factor(branch)))` is then added to this active plot
 within the annotation stack.

## control size
You can specify the heatmap body sizes (`width`/`height`) using the
`ggheatmap()` function. Alternatively, the `hmanno()` function allows you to
control the heatmap body sizes, and it can also set the overall size of the
annotation stack.

- **when `position` is `NULL`**: we can use `width` and `height` arguments to
control the relative (you can also provide a unit object) width and height of
the heatmap body.
- **when `position` is a string**: we can use `size` argument to control the
relative width (left and right annotation) or height (top and bottom annotation)
of the whole annotation stack.

```{r}
ggheatmap(small_mat, height = 1) +
  scale_fill_viridis_c() +
  hmanno("t", size = 2) +
  align_dendro() +
  ggalign(data = rowSums) +
  geom_bar(aes(y = value, fill = .x), stat = "identity")
```

```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = 1) +
  align_dendro() +
  ggalign(data = rowSums) +
  geom_bar(aes(y = value, fill = .x), stat = "identity")
```

We can use `unit()` to define the size.
```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = unit(30, "mm")) +
  align_dendro() +
  ggalign(data = rowSums) +
  geom_bar(aes(y = value, fill = .x), stat = "identity")
```

Some `align_*()` functions has a `size` argument to control the relative width
(left and right annotation) or height (top and bottom annotation) of the single
plot in the whole annotation stack.
```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("l", size = 0.2) +
  ggalign(data = rowSums, aes(x = value), size = unit(10, "mm")) +
  geom_bar(
    aes(y = .y, fill = factor(.y)),
    stat = "identity",
    orientation = "y"
  ) +
  scale_fill_brewer(palette = "Set1", guide = "none") +
  scale_x_reverse()
```

## guide legends
By default, `ggheatmap()` will collect all guide legends on the side they
originate from.

```{r fig.dim = c(12, 12)}
heatmap_with_four_side_guides <- ggheatmap(small_mat) +
  scale_fill_viridis_c(name = "I'm from heatmap body") +
  theme(axis.text.x = element_text(angle = -60, hjust = 0)) +
  hmanno("t") +
  align_dendro(aes(color = branch), k = 3L) +
  scale_color_brewer(
    name = "I'm from top tree", palette = "Dark2",
    guide = guide_legend(position = "right")
  ) +
  hmanno("l") +
  align_dendro(aes(color = branch), k = 3L) +
  scale_color_brewer(
    name = "I'm from left tree", palette = "Dark2",
    guide = guide_legend(position = "top")
  ) +
  scale_x_reverse() +
  hmanno("b") +
  align_dendro(aes(color = branch), k = 3L) +
  scale_color_brewer(
    name = "I'm from bottom tree", palette = "Dark2",
    guide = guide_legend(position = "left")
  ) +
  scale_y_reverse() +
  hmanno("r") +
  align_dendro(aes(color = branch), k = 3L) +
  scale_color_brewer(
    name = "I'm from right tree", palette = "Dark2",
    guide = guide_legend(position = "bottom")
  ) &
  theme(plot.margin = margin())
heatmap_with_four_side_guides
```

`hmanno()` provides `guides` and `free_guides` argument to provide precise
control over the guide legend position. 

### guides
`guides` argument controls which positions of guide legends should be collected
in the layout. They will be collected to their original side.

For a heatmap layout, it has five plots (heatmap body, four sides of the nested
heatmap annotation stack). Here we only collect guides in the top and bottom
side. When position is `NULL`, `hmanno()` set the `guides` for the heatmap
layout.
```{r heatmap-guides-tb, fig.dim = c(12, 12), fig.cap="Heatmap collect top and bottom guides only"}
heatmap_with_four_side_guides +
  hmanno(guides = "tb") # we set the `guides` argument here
```

### free_guides
The `free_guides` argument allows you to override the `guides` argument for a
single plot. In the last example, the heatmap body right side legend won't be
collected. We can use `free_guides` to override the `guides` argument for the
heatmap body plot.

```{r fig.dim = c(12, 12)}
heatmap_with_four_side_guides +
  hmanno(guides = "tb") + # we set the `guides` argument here
  hmanno(free_guides = "r") # we collect the right guide legend for the heatmap body
```
You can also use `free_guides` to override the `guides` argument for heatmap
annotation stack in `hmanno()`.

### heatmap annotation guide legends
When position is a string, `hmanno()` set the `guides` for the heatmap
annotation stack.
```{r fig.dim = c(12, 12)}
heatmap_with_four_side_guides +
  hmanno(guides = "tb") + # we set the `guides` argument here
  hmanno(free_guides = "r") + # we collect the right guide legend for the heatmap body
  hmanno("l", guides = NULL) + # the left annotation won't collect the guide legends
  guides(color = guide_legend(direction = "vertical", position = "top"))
```

In the nested layouts, the top-level layout won't collect guide legends from
plots within the nested layout unless the nested layout collects them first.
Guide legends in the heatmap layout will only be collected from the annotation
stack if the stack layout collects its own guide legends first.

An annotation stack is simply a `stack_layout()`, which can add multiple plots
using `align_*()` functions. The `align_*()` functions include a `free_guides`
argument to override the `guides` setting in the annotation stack layout.

## free_spaces
By default, `ggheatmap()` will align all elements of the plot, which can
sometimes lead to unwanted spacing. Consider the following example:

```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = unit(30, "mm")) +
  align_dendro() +
  scale_y_continuous(
    expand = expansion(),
    labels = ~ paste("very very long labels", .x)
  ) +
  hmanno("l") +
  align_dendro() +
  scale_x_reverse(expand = expansion())
```

Both `free_spaces` and `free_labs` operate on individual plots, while layout
values set global parameters for the entire layout. This means that `align_*`
functions will inherit these values, but you can override them within the
`align_*` functions.

- **If `position` is `NULL`**: These arguments control the behavior of the heatmap 
  body and set the global values for the heatmap layout. Setting to `waiver()` 
  inherits from the parent layout.

- **If `position` is a string**: These arguments set the global values for the 
  annotation stack layout. If set to `waiver()`, it inherits from specific
  heatmap layout axes:
  - For top and bottom annotations, it inherits from the left ("l") and right ("r") 
    axes.
  - For left and right annotations, it inherits from the top ("t") and bottom ("b") 
    axes.

In this case, the left annotation stack is positioned far from the heatmap body
due to the wide axis labels in the top annotation stack. This occurs because the
top annotation stack is aligned with the heatmap body. To fix this, you can
remove the left borders around the panel of the top annotation stack by setting
`free_spaces = "l"`.

```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = unit(30, "mm"), free_spaces = "l") +
  align_dendro() +
  scale_y_continuous(
    expand = expansion(),
    labels = ~ paste("very very long labels", .x)
  ) +
  hmanno("l") +
  align_dendro() +
  scale_x_reverse(expand = expansion())
```

In the Figure \@ref(fig:heatmap-guides-tb) we can also use the `free_spaces` to
make a compact heatmap. Here, we remove the right border spaces of the top
annotation stack, and the left border spaces of the bottom annotation stack.
```{r fig.dim = c(12, 12)}
heatmap_with_four_side_guides +
  hmanno(guides = "tb") + # we set the `guides` argument here
  hmanno("t", free_spaces = "r") + # we remove the right border spaces
  hmanno("b", free_spaces = "l") # we remove the left border spaces
```

`align_*()` functions include the `free_spaces` argument, which, by default,
inherits from the annotation stack. This allows you to control the alignment
for each plot individually.

```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  hmanno("t", size = unit(30, "mm")) +
  align_dendro(free_labs = "l") +
  scale_y_continuous(
    expand = expansion(),
    labels = ~ paste("very very long labels", .x)
  ) +
  hmanno("l") +
  align_dendro() +
  scale_x_reverse(expand = expansion())
```

## free_labs
By default, `ggheatmap()` won't align the axis titles.
```{r}
ggheatmap(small_mat) +
  scale_fill_viridis_c() +
  ylab("Heatmap title") +
  hmanno("t", size = unit(30, "mm")) +
  align_dendro() +
  ylab("Annotation title")
```

To align all axis titles, you can set `free_labs = NULL` in the `hmanno()`
function. Alternatively, A single string containing one or more of axis
positions ("t", "l", "b", "r") to indicate which axis titles should be free from
alignment.

```{r}
ggheatmap(small_mat) +
  hmanno(free_labs = NULL) +
  scale_fill_viridis_c() +
  ylab("Heatmap title") +
  hmanno("t", size = unit(30, "mm")) +
  align_dendro() +
  ylab("Annotation title")
```

The same with `free_spaces` argument, you can control the `free_labs` argument
for the individual plot in `align_*()` function.

## Session information
```{r}
sessionInfo()
```
